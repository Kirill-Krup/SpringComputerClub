<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Бронирование места — Кибер Арена</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <link rel="stylesheet" href="/Css/Client/booking.css"/>
</head>
<body>
<header class="main-header">
    <div class="container">
        <div class="logo">
            <a href="/">
                <i class="fas fa-gamepad"></i>
                <span class="logo-accent">Кибер Арена</span>
            </a>
        </div>

        <div class="main-nav-and-profile">
            <nav class="main-nav">
                <ul>
                    <li><a th:href="@{/home}">Главная</a></li>
                    <li><a th:href="@{/home#arena}">Арена</a></li>
                    <li><a th:href="@{/home#pricing}">Тарифы</a></li>
                    <li><a th:href="@{/home#contacts}">Контакты</a></li>
                </ul>
            </nav>

            <div class="header-right">
                <a th:href="@{/profile}">
                    <div class="profile-container" title="Профиль пользователя">
                        <div class="profile-text">
                            <div class="profile-name" th:text="${user.getLogin()}"></div>
                            <div class="profile-balance" th:text="${user.getWallet() + ' BYN'}"></div>
                        </div>
                        <img th:src="${user.getPhotoPath()  }" alt="Фото профиля" class="profile-photo" />
                    </div>
                </a>
                <form th:action="@{/logout}" method="post" class="logout-form">
                    <input type="hidden" th:name = "${_csrf.parameterName}" th:value = "${_csrf.token}">
                    <button type="submit" class="logout-btn">Выйти</button>
                </form>
            </div>
        </div>
    </div>
</header>

<!-- Контент -->
<main class="booking">
    <div class="container">
        <div class="form-card">
            <div class="form-card__head">
                <h1><i class="fa-solid fa-chair"></i> Забронировать место</h1>
                <p class="muted">Выберите день, время, ПК и тариф</p>
            </div>

            <form action="/booking" method="post" class="booking-form">
                <input type="hidden" id="selectedPc" name="selectedPc">
                <input type="hidden" id="selectedPlan" name="selectedPlan">
                <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>

                <section class="step">
                    <h2><i class="fa-regular fa-calendar"></i> День и время</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="day">Дата начала <span class="req">*</span></label>
                            <input type="date" id="day" name="day" class="small-input" required>
                        </div>
                        <div class="form-group">
                            <label for="time">Время начала <span class="req">*</span></label>
                            <input type="time" id="time" name="time" class="small-input" step="1800" required>
                        </div>
                        <div class="form-group">
                            <label for="endDay">Дата окончания <span class="req">*</span></label>
                            <input type="date" id="endDay" name="endDay" class="small-input" required>
                        </div>
                        <div class="form-group">
                            <label for="endTime">Время окончания <span class="req">*</span></label>
                            <input type="time" id="endTime" name="endTime" class="small-input" step="1800" required>
                        </div>
                    </div>
                </section>


                <!-- Секция с этажами -->
                <section class="step">
                    <h2><i class="fa-solid fa-desktop"></i> Выберите место</h2>
                    <div class="floor-segment">
                        <div class="floor-segment__track" id="floorSegment" role="tablist" aria-label="Этаж">
                            <button type="button" class="floor-segment__btn" data-floor="0">Этаж 0</button>
                            <button type="button" class="floor-segment__btn" data-floor="1">Этаж 1</button>
                            <button type="button" class="floor-segment__btn" data-floor="2">Этаж 2</button>
                            <span class="floor-segment__indicator" aria-hidden="true"></span>
                        </div>
                    </div>
                    <!-- ЭТАЖ 0 -->
                    <div class="floor" data-floor = "0">
                        <div class="layout-container">
                            <div class="left-side">
                                <div class="left-top">
                                    <div class="pc-row" style="margin-top: 150px; margin-left: 90px">
                                        <button type="button">PS5 1</button>
                                        <button type="button">PS5 2</button>
                                        <button type="button">PS5 3</button>
                                        <button type="button">PS5 4</button>
                                    </div>
                                    <div class="pc-column-row">
                                    </div>
                                </div>
                                <div class="door-gap"></div>
                                <div class="left-bottom">
                                    <div class="pc-column-row" style="margin-top: 50px">
                                        <button type="button" class="pc-seat">PS5 5</button>
                                        <button type="button" class="pc-seat">PS5 6</button>
                                        <button type="button" class="pc-seat">PS5 7</button>
                                        <button type="button" class="pc-seat">PS5 8</button>
                                    </div>
                                    <div class="pc-row">

                                    </div>
                                </div>
                            </div>
                            <div class="right-side">
                                <div class="stair">
                                    <img src="/Images/stairsUp.png" alt="Лестница вверх">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ЭТАЖ 1 -->
                    <div class="floor active" data-floor = "1">
                        <div class="layout-container">
                            <div class="left-side">
                                <div class="left-top">
                                    <div class="pc-row">
                                        <button type="button" class="pc-seat">ПК 1</button>
                                        <button type="button" class="pc-seat">ПК 2</button>
                                        <button type="button" class="pc-seat">ПК 3</button>
                                        <button type="button" class="pc-seat">ПК 4</button>
                                        <button type="button" class="pc-seat">ПК 5</button>
                                        <button type="button" class="pc-seat">ПК 6</button>
                                    </div>
                                    <div class="pc-column-row" style="margin-top: 100px">
                                        <button type="button" class="pc-seat">ПК 7</button>
                                        <button type="button" class="pc-seat">ПК 8</button>
                                        <button type="button" class="pc-seat">ПК 9</button>
                                        <button type="button" class="pc-seat">ПК 10</button>
                                    </div>
                                </div>
                                <div class="door-gap"></div>
                                <div class="left-bottom">
                                    <div class="pc-column-row" style="margin-top: 60px">
                                        <button type="button" class="pc-seat">ПК 11</button>
                                        <button type="button" class="pc-seat">ПК 12</button>
                                        <button type="button" class="pc-seat">ПК 13</button>
                                        <button type="button" class="pc-seat">ПК 14</button>
                                    </div>
                                    <div class="pc-row" style="margin-top: 100px">
                                        <button type="button" class="pc-seat">ПК 15</button>
                                        <button type="button" class="pc-seat">ПК 16</button>
                                        <button type="button" class="pc-seat">ПК 17</button>
                                        <button type="button" class="pc-seat">ПК 18</button>
                                        <button type="button" class="pc-seat">ПК 19</button>
                                        <button type="button" class="pc-seat">ПК 20</button>
                                    </div>
                                </div>
                            </div>
                            <div class="right-side">
                                <div class="stairs">
                                    <img src="/Images/stairsUp.png" alt="Лестница вверх">
                                    <img src="/Images/stairsDown.png" alt="Лестница вниз">
                                </div>
                                <div class="enter">Вход</div>
                            </div>
                        </div>
                    </div>
                    <!-- ЭТАЖ 2 -->
                    <div class="floor" data-floor = "2">
                        <div class="layout-container">
                            <div class="left-side">
                                <div class="left-top" style="display: flex; gap: 10px">
                                    <div class="left-in-left-top">
                                        <button type="button" class="vip">VIP 1(ПК)</button>
                                    </div>
                                    <div class="right-in-left-top">
                                        <button type="button" class="vip">VIP 2(ПК + PS5)</button>
                                    </div>
                                </div>
                                <div class="door-gap"></div>
                                <div class="left-bottom">
                                    <button type="button" class="vip" style="height: 80%;margin-top: 55px">VIP 3 (5 ПК + 2 PS5)</button>
                                </div>
                            </div>
                            <div class="right-side">
                                <div class="stair">
                                    <img src="/Images/stairsDown.png" alt="Лестница вниз">
                                </div>
                            </div>
                        </div>
                    </div>

                </section>

                <!-- Секция с тарифами -->
                <section class="step">
                    <div id="pricing">
                        <div class="container">
                            <h2 class="section-title">Наши <span class="accent">Тарифы</span></h2>
                            <p class="section-subtitle">Выбирайте оптимальный вариант для вашего игрового опыта.</p>
                            <div class="pricing-grid">
                                <div class="pricing-card" data-plan="hourly" data-price="4">
                                    <h3>Пакет "Час Игры"</h3>
                                    <div class="price"><span>4</span> BYN/час</div>
                                    <ul>
                                        <li><i class="fas fa-check"></i> Доступ к стандартным ПК</li>
                                        <li><i class="fas fa-check"></i> Базовая периферия</li>
                                        <li><i class="fas fa-check"></i> Широкий выбор игр</li>
                                        <li class="unavailable"><i class="fas fa-times"></i> Приватная комната</li>
                                        <li class="unavailable"><i class="fas fa-times"></i> Приоритетная поддержка</li>
                                    </ul>
                                </div>
                                <div class="pricing-card" data-plan="3hours" data-price="10">
                                    <h3>Пакет "Кибер Атлет"</h3>
                                    <div class="price"><span>10</span> BYN/3 часа</div>
                                    <ul>
                                        <li><i class="fas fa-check"></i> Доступ к Premium ПК</li>
                                        <li><i class="fas fa-check"></i> Pro периферия</li>
                                        <li><i class="fas fa-check"></i> Приоритетная бронь</li>
                                        <li><i class="fas fa-check"></i> Скидки в баре</li>
                                        <li class="unavailable"><i class="fas fa-times"></i> Приватная комната</li>
                                    </ul>
                                </div>
                                <div class="pricing-card" data-plan="VipArena" data-price="40">
                                    <h3>Пакет "Командная Битва"</h3>
                                    <div class="price"><span>40</span> BYN/3 часа</div>
                                    <ul>
                                        <li><i class="fas fa-check"></i> Приватная комната (5 ПК)</li>
                                        <li><i class="fas fa-check"></i> Premium ПК и периферия</li>
                                        <li><i class="fas fa-check"></i> Персональный менеджер</li>
                                        <li><i class="fas fa-check"></i> 10% скидка на еду/напитки</li>
                                        <li><i class="fas fa-check"></i> Приоритет в турнирах</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- действия -->
                <div class="form-actions">
                    <button type="submit" class="btn-primary">
                        <i class="fa-solid fa-check"></i> Забронировать
                    </button>
                    <a href="/" class="btn-ghost"><i class="fa-regular fa-circle-left"></i> Назад</a>
                </div>
            </form>
        </div>
    </div>
</main>

<footer class="site-footer">
    <div class="container">
        <p class="muted">© Кибер Арена, 2025</p>
    </div>
</footer>

<script>
    const dateInput = document.getElementById('day');
    const timeInput = document.getElementById('time');
    const endDateInput = document.getElementById('endDay');
    const endTimeInput = document.getElementById('endTime');

    const today = new Date();
    const maxDate = new Date();
    maxDate.setDate(today.getDate() + 14);

    const toISO = (d) => d.toISOString().split('T')[0];

    dateInput.min = toISO(today);
    dateInput.max = toISO(maxDate);

    function updateEndDateLimits() {
        if (!dateInput.value) return;
        const startDate = new Date(dateInput.value);

        const minEnd = new Date(startDate);
        minEnd.setDate(startDate.getDate());

        const maxEnd = new Date(startDate);
        maxEnd.setDate(startDate.getDate() + 15); // максимум +15 дней

        endDateInput.min = toISO(minEnd);
        endDateInput.max = toISO(maxEnd);

        if (endDateInput.value && (endDateInput.value < endDateInput.min || endDateInput.value > endDateInput.max)) {
            endDateInput.value = "";
        }
    }

    dateInput.addEventListener("change", updateEndDateLimits);

    if (dateInput.showPicker) {
        dateInput.addEventListener("click", () => dateInput.showPicker());
    }
    if (timeInput.showPicker) {
        timeInput.addEventListener("click", () => timeInput.showPicker());
    }
    if (endDateInput.showPicker) {
        endDateInput.addEventListener("click", () => endDateInput.showPicker());
    }
    if (endTimeInput.showPicker) {
        endTimeInput.addEventListener("click", () => endTimeInput.showPicker());
    }

    endTimeInput.addEventListener("change", () => {
        const startDate = dateInput.value;
        const endDate = endDateInput.value;
        const startTime = timeInput.value;
        const endTime = endTimeInput.value;

        if (endDate === startDate) {
            if (endTime <= startTime) {
                const d = new Date(startDate);
                d.setDate(d.getDate() + 1);
                endDateInput.value = d.toISOString().split("T")[0];
            }
        }
    });

    const steps = document.querySelectorAll("section.step");

    function lockStep(step) {
        step.style.opacity = "0.2";
        step.style.pointerEvents = "none";
    }

    function unlockStep(step) {
        step.style.opacity = "1";
        step.style.pointerEvents = "auto";
    }

    steps.forEach((s, i) => {
        if (i > 0) lockStep(s);
    });


    function checkStep1() {
        const day = document.getElementById("day").value;
        const time = document.getElementById("time").value;
        const endDay = document.getElementById("endDay").value;
        const endTime = document.getElementById("endTime").value;

        if (day && time && endDay && endTime) {
            checkReservations(day,time,endDay,endTime);
            unlockStep(steps[1]);
        } else {
            lockStep(steps[1]);
            lockStep(steps[2]);
        }
    }

    function checkStep2() {
        const sel = document.getElementById("selectedPc");
        if (!sel) return;

        if (sel.value) {
            if (steps[2]) unlockStep(steps[2]);
        } else {
            if (steps[2]) lockStep(steps[2]);
        }
    }

    ["day", "time", "endDay", "endTime"].forEach(id => {
        document.getElementById(id).addEventListener("input", checkStep1);
    });

    document.querySelectorAll(".pc-seat").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".pc-seat").forEach(b => b.classList.remove("selected"));

            btn.classList.add("selected");
            document.getElementById("selectedPc").value = btn.textContent.trim();

            checkStep2();
        });
    });


    checkStep1();
    checkStep2();


    const segment = document.getElementById('floorSegment');
    const indicator = segment.querySelector('.floor-segment__indicator');
    const segButtons = Array.from(segment.querySelectorAll('.floor-segment__btn'));
    const floorViews = Array.from(document.querySelectorAll('.floor'));

    function setActiveFloor(floorIdx) {
        segButtons.forEach((b) => {
            const isActive = Number(b.dataset.floor) === floorIdx;
            b.classList.toggle('is-active', isActive);
            b.setAttribute('aria-selected', String(isActive));
        });

        indicator.style.transform = `translateX(${floorIdx * 100}%)`;

        floorViews.forEach((v) => v.classList.toggle('active', Number(v.dataset.floor) === floorIdx));
    }

    segButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
            setActiveFloor(Number(btn.dataset.floor));
        });
    });
    setActiveFloor(1);


    function roundTimeTo30Minutes(timeString) {
        if (!timeString) return '';

        const [hours, minutes] = timeString.split(':').map(Number);
        const roundedMinutes = minutes < 30 ? 0 : 30;
        return `${hours.toString().padStart(2, '0')}:${roundedMinutes.toString().padStart(2, '0')}`;
    }


    document.getElementById('time').addEventListener('change', function() {
        this.value = roundTimeTo30Minutes(this.value);
        checkStep1();
    });

    document.getElementById('endTime').addEventListener('change', function() {
        this.value = roundTimeTo30Minutes(this.value);
        checkStep1();
    });

    document.getElementById('time').addEventListener('blur', function() {
        if (this.value) {
            this.value = roundTimeTo30Minutes(this.value);
            checkStep1();
        }
    });

    document.getElementById('endTime').addEventListener('blur', function() {
        if (this.value) {
            this.value = roundTimeTo30Minutes(this.value);
            checkStep1();
        }
    });

    // ПРОВЕРКА ВЫБРАННОГО ТАРИФА
    let selectedPlan = null;

    document.querySelectorAll(".pricing-card").forEach(card => {
        card.addEventListener("click", () => {
            document.querySelectorAll(".pricing-card").forEach(c => c.classList.remove("featured"));
            card.classList.add("featured");

            selectedPlan = {
                plan: card.dataset.plan,
                price: card.dataset.price
            };

            console.log("Выбран тариф:", selectedPlan);
        });
    });

    // ФУНКЦИИ СБОРА ДАННЫХ, ОТПРАВКИ, ВАЛИДАЦИИ И ТД
    document.querySelector(".booking-form").addEventListener('submit', async function(e){
       e.preventDefault();
       const collectedData = collectData();
       await sendBookingData(collectedData);
    });

    function collectData(){
        const selectedPC = document.getElementById('selectedPc').value;
        return{
            startDate: dateInput.value, startTime: timeInput.value, endDate: endDateInput.value, endTime: endTimeInput.value,
            reservationPlace: selectedPC, selectedTariff: selectedPlan ? selectedPlan.plan : null,
            totalPrice: calculatePrice(dateInput.value, timeInput.value, endDateInput.value, endTimeInput.value, selectedPlan ? selectedPlan.price : null)
        }
    }

    function calculatePrice(startDate, startTime, endDate, endTime, pricePerHour){
        if(!pricePerHour) return '0';
        const start = new Date(`${startDate}T${startTime}`);
        const end = new Date(`${endDate}T${endTime}`);
        const hours = (end-start) / (1000 * 60 * 60);
        return hours * parseFloat(pricePerHour).toFixed(2)
    }

    async function sendBookingData(bookingData) {
        try {
            const submitBtn = document.querySelector('.btn-primary');
            const originalText = submitBtn.innerHTML;

            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Отправка...';
            submitBtn.disabled = true;

            const response = await fetch('/booking', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                },
                body: JSON.stringify(bookingData)
            });

            if (response.ok) {
                const result = await response.json();
                showSuccessMessage('Бронирование успешно создано!');
                setTimeout(() => {
                    window.location.href = '/profile';
                }, 2000);
            } else {
                const error = await response.json();
                throw new Error(error.message || 'Ошибка сервера');
            }

        } catch (error) {
            console.error('Ошибка:', error);
            showErrorMessage(error.message || 'Произошла ошибка при бронировании');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    function showSuccessMessage(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-success';
        alert.innerHTML = `
        <i class="fa-solid fa-check-circle"></i>
        ${message}
    `;
        document.body.appendChild(alert);

        setTimeout(() => alert.remove(), 3000);
    }

    function showErrorMessage(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-error';
        alert.innerHTML = `
        <i class="fa-solid fa-exclamation-circle"></i>
        ${message}
    `;
        document.body.appendChild(alert);

        setTimeout(() => alert.remove(), 5000);
    }

    async function checkReservations(startDate, startTime, endDate, endTime){
        try{
            const responce = await fetch(`/booking/getReservations?startDate=${startDate}&startTime=${startTime}&endDate=${endDate}&endTime=${endTime}`);
            const reservations = await responce.json();

            document.querySelectorAll(".pc-seat, .vip").forEach(btn=>{
                btn.classList.remove("reserved");
            });

            reservations.forEach(element=>{
                document.querySelectorAll(".pc-seat, .vip").forEach(btn=>{
                    if(btn.textContent.trim() === element.reservationPlace){
                        btn.classList.add("reserved");
                    }
                });
            });
        }catch(err){
            console.log("Ошибка получения данных");
        }
    }

</script>
</body>
</html>
